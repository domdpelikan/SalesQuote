<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Sales Quote</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .page-container { width: 100%; max-width: 900px; }
        .main-card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #2d7a7f 0%, #1f5a5e 100%); color: white; padding: 32px; text-align: center; }
        .card-header h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.5px; }
        .card-header h2 { font-size: 18px; font-weight: 400; opacity: 0.95; color: #f39237; }
        .card-content { padding: 32px; }
        section { margin-bottom: 32px; }
        section:last-child { margin-bottom: 0; }
        h3 { font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 16px; }
        .item-info p { font-size: 15px; color: #4b5563; margin-bottom: 8px; line-height: 1.6; }
        .item-info strong { color: #1f2937; font-weight: 600; }
        .divider { border: none; border-top: 1px solid #e5e7eb; margin: 32px 0; }
        .form-group { margin-bottom: 20px; }
        .price-group { display: flex; gap: 20px; }
        .price-group .form-group { flex: 1; }
        label { display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px; }
        input[type="text"], input[type="search"], select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            background: white;
        }
        textarea { resize: vertical; }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2d7a7f;
            box-shadow: 0 0 0 3px rgba(45, 122, 127, 0.1);
        }
        input::placeholder, textarea::placeholder { color: #9ca3af; }
        button {
            background: linear-gradient(135deg, #2d7a7f 0%, #1f5a5e 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        button:hover { transform: translateY(-1px); }
        button:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
        #formMessage { margin-top: 16px; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; display: none; }
        #formMessage.success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; display: block; }
        #formMessage.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; display: block; }
        .history-container { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f3f4f6; }
        th { text-align: left; padding: 12px; font-weight: 600; color: #374151; font-size: 14px; border-bottom: 2px solid #e5e7eb; }
        td { padding: 12px; color: #4b5563; font-size: 14px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .price-cell { min-width: 120px; }
        .notes-cell button { font-size: 14px; color: #2d7a7f; background: none; border: none; padding: 4px; cursor: pointer; font-weight: 600; }
        .notes-cell button:hover { text-decoration: underline; }
        tbody tr:last-child td { border-bottom: none; }
        #searchHistoryTable tbody tr:hover { background: #f0f9ff; cursor: pointer; } /* Highlight for clickable rows */
        .no-history-message { display: none; text-align: center; padding: 32px; color: #9ca3af; font-size: 15px; }
        
        .action-button { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; }
        .action-button:hover { background-color: #e5e7eb; }
        .action-button svg { width: 20px; height: 20px; color: #6b7280; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .modal-header h4 { font-size: 18px; font-weight: 600; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-footer .btn-secondary { background: #e5e7eb; color: #374151; }
        .modal-footer .btn-danger { background: #ef4444; color: white; }
        .modal-footer .btn-primary { background: #2d7a7f; color: white; }

        @media (max-width: 640px) {
            .card-header h1 { font-size: 24px; }
            .card-header h2 { font-size: 16px; }
            .card-content { padding: 24px; }
            th, td { padding: 8px; font-size: 13px; }
            .price-group { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="main-card">
            <header class="card-header">
                <h1>iMED ALL inc.</h1>
                <h2>Sales Quote</h2>
            </header>
            <div class="card-content">
                <section class="item-info">
                    <h3>Item Details</h3>
                    <p><strong>Name:</strong> <span id="itemName">Loading...</span></p>
                    <p><strong>Part Number:</strong> <span id="partNumber">...</span></p>
                </section>

                <hr class="divider">

                <section class="quote-form">
                    <h3>Create New Quote</h3>
                    <form id="newQuoteForm">
                        <div class="form-group">
                            <label for="customer">Sold:</label>
                            <select id="customer" name="customer" required>
                                <option value="" disabled selected>Loading Customers...</option>
                            </select>
                        </div>
                        <div class="price-group">
                            <div class="form-group">
                                <label for="outrightPrice">Outright Quote ($):</label>
                                <input type="text" id="outrightPrice" name="outrightPrice" placeholder="e.g., 2,000.00">
                            </div>
                            <div class="form-group">
                                <label for="exchangePrice">Exchange Quote ($):</label>
                                <input type="text" id="exchangePrice" name="exchangePrice" placeholder="e.g., 1,500.00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select id="status" name="status" required>
                                <option value="Quoted">Quoted</option>
                                <option value="Sold at Quoted Price">Sold at Quoted Price</option>
                                <option value="Lost Sale">Lost Sale</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes:</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Add any internal notes for this quote..."></textarea>
                        </div>
                        <button type="submit" id="submitButton">Save Quote</button>
                    </form>
                    <p id="formMessage"></p>
                </section>
                
                <hr class="divider">

                <section class="quote-history">
                    <h3>Quote History for this Part</h3>
                    <div class="history-container">
                        <table id="historyTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Sold</th>
                                    <th class="price-cell">Outright</th>
                                    <th class="price-cell">Exchange</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody"></tbody>
                        </table>
                        <p id="noHistoryMessage" class="no-history-message">No quote history found for this part.</p>
                    </div>
                </section>

                <hr class="divider">
                <section class="sales-history-graph">
                    <h3>Sales History Graph</h3>
                    <div class="history-container">
                        <canvas id="salesHistoryChart"></canvas>
                        <p id="noSalesDataMessage" class="no-history-message" style="display: none;">No sales history available for this part.</p>
                    </div>
                </section>

                <hr class="divider">

                <section class="searchable-quote-history">
                    <h3>Search All Quotes</h3>
                    <div class="form-group">
                        <input type="search" id="quoteSearchInput" placeholder="Search by PN, Sold To, or Item Name...">
                    </div>
                    <div class="history-container">
                        <table id="searchHistoryTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>PN</th>
                                    <th>Sold</th>
                                    <th class="price-cell">Outright</th>
                                    <th class="price-cell">Exchange</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="searchHistoryBody"></tbody>
                        </table>
                        <p id="noSearchResultsMessage" class="no-history-message">Type in the search bar to find quotes.</p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Edit Modal HTML -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Edit Quote</h4>
            </div>
            <div class="modal-body">
                <form id="editQuoteForm">
                    <input type="hidden" id="editQuoteId">
                    <div class="form-group">
                        <label for="editSoldTo">Sold:</label>
                        <select id="editSoldTo" name="sold" required></select>
                    </div>
                    <div class="price-group">
                        <div class="form-group">
                            <label for="editOutrightPrice">Outright Quote ($):</label>
                            <input type="text" id="editOutrightPrice" name="outrightPrice">
                        </div>
                        <div class="form-group">
                            <label for="editExchangePrice">Exchange Quote ($):</label>
                            <input type="text" id="editExchangePrice" name="exchangePrice">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">Status:</label>
                        <select id="editStatus" name="status" required>
                            <option value="Quoted">Quoted</option>
                            <option value="Sold at Quoted Price">Sold at Quoted Price</option>
                            <option value="Lost Sale">Lost Sale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNotes">Notes:</label>
                        <textarea id="editNotes" name="notes" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="deleteQuoteButton" class="btn-danger">Delete</button>
                <div>
                    <button type="button" id="cancelEditButton" class="btn-secondary">Cancel</button>
                    <button type="button" id="saveEditButton" class="btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // --- START CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyCe0u6B6qA9y6xvSR_jbY1Do-ljPKy5Lu8",
          authDomain: "imed-sales-quote.firebaseapp.com",
          databaseURL: "https://imed-sales-quote-default-rtdb.firebaseio.com",
          projectId: "imed-sales-quote",
          storageBucket: "imed-sales-quote.firebasestorage.app",
          messagingSenderId: "830326754595",
          appId: "1:830326754595:web:ca03272749599736fad096",
          measurementId: "G-6TCTDFX5PL"
        };
        
        const APPSHEET_CONFIG = {
            API_KEY: "V2-p5nLK-I6suM-yAVyE-bhP5n-TaFuq-uDBbY-vjvr0-8RoEu",
            APP_ID: "876dcdc3-0570-427f-9be0-53367d74bf69",
            TABLE_NAME: "Siemens Stock",
            CUSTOMER_COLUMN: "Sold"
        };
        // --- END CONFIGURATION ---

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allQuotesCache = [];
        let soldListCache = [];
        let salesHistoryChart; 
        let currentHistoryListener = null;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const initialPartNumber = urlParams.get('pn');
            const initialItemName = urlParams.get('name');
            
            if (!initialPartNumber) { 
                document.getElementById('itemName').textContent = 'N/A';
                document.getElementById('partNumber').textContent = 'N/A';
                return; 
            }
            
            updateMainView(initialPartNumber, initialItemName);
            fetchCustomersFromAppSheet();
            fetchAllQuotesForSearch();
            checkAndExpireQuotes(); // NEW: Run the check on page load

            // Event Listeners
            document.getElementById('newQuoteForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('quoteSearchInput').addEventListener('input', (e) => filterAndDisplayQuotes(e.target.value));
            
            ['outrightPrice', 'exchangePrice', 'editOutrightPrice', 'editExchangePrice'].forEach(id => {
                document.getElementById(id).addEventListener('input', handleCurrencyInput);
                document.getElementById(id).addEventListener('blur', handleCurrencyBlur);
            });

            document.getElementById('cancelEditButton').addEventListener('click', closeEditModal);
            document.getElementById('saveEditButton').addEventListener('click', handleEditFormSubmit);
            document.getElementById('deleteQuoteButton').addEventListener('click', handleDeleteQuote);
            document.getElementById('editModal').addEventListener('click', (e) => {
                if (e.target.id === 'editModal') closeEditModal();
            });

            document.body.addEventListener('click', (e) => {
                const actionButton = e.target.closest('[data-action]');
                if (actionButton) {
                    const action = actionButton.dataset.action;
                    const quote = JSON.parse(actionButton.dataset.quote || '{}');

                    if (action === 'edit-quote') {
                        openEditModal(quote);
                    } else if (action === 'view-notes') {
                        alert(quote.notes || 'No notes for this quote.');
                    }
                    return; 
                }

                const searchRow = e.target.closest('#searchHistoryBody tr');
                if (searchRow) {
                    const pn = searchRow.dataset.pn;
                    const itemName = searchRow.dataset.itemName;
                    if (pn && itemName) {
                        updateMainView(pn, itemName);
                        window.scrollTo(0, 0);
                    }
                }
            });
        });
        
        function updateMainView(pn, itemName) {
            document.getElementById('itemName').textContent = itemName || 'N/A';
            document.getElementById('partNumber').textContent = pn || 'N/A';
            
            if (currentHistoryListener) {
                currentHistoryListener.off();
            }
            listenForQuoteHistory(pn);
        }

        async function fetchCustomersFromAppSheet() {
            const customerSelect = document.getElementById('customer');
            const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.TABLE_NAME);
            const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY },
                    body: JSON.stringify({ "Action": "Find", "Properties": {}, "Rows": [] })
                });
                if (!response.ok) throw new Error(`Failed to fetch customers: ${response.statusText}`);
                const data = await response.json();
                customerSelect.innerHTML = '<option value="" disabled selected>Select from Sold List...</option>';
                const customerNames = new Set();
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        const customerName = item[APPSHEET_CONFIG.CUSTOMER_COLUMN];
                        if (customerName && customerName.trim() !== '') customerNames.add(customerName.trim());
                    });
                }
                soldListCache = Array.from(customerNames).sort();
                soldListCache.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name; 
                    option.textContent = name;
                    customerSelect.appendChild(option.cloneNode(true));
                });
            } catch (error) {
                console.error("Error fetching customers:", error);
                customerSelect.innerHTML = '<option value="" disabled>Error loading customers</option>';
            }
        }
        
        function formatPrice(price) {
            const num = parseFloat(price);
            if (isNaN(num)) return '—';
            return `$${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        function handleCurrencyInput(event) {
            const input = event.target; let value = input.value; let cursorPosition = input.selectionStart;
            const commasBefore = (value.substring(0, cursorPosition).match(/,/g) || []).length;
            let numericValue = value.replace(/[^0-9.]/g, '');
            const parts = numericValue.split('.');
            if (parts.length > 2) numericValue = parts[0] + '.' + parts.slice(1).join('');
            const [integerPart, decimalPart] = numericValue.split('.');
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            let finalValue = formattedInteger;
            if (decimalPart !== undefined) finalValue += '.' + decimalPart.substring(0, 2);
            input.value = finalValue;
            const commasAfter = (input.value.substring(0, cursorPosition).match(/,/g) || []).length;
            cursorPosition += (commasAfter - commasBefore);
            if(cursorPosition < 0) cursorPosition = 0;
            input.setSelectionRange(cursorPosition, cursorPosition);
        }
        
        function handleCurrencyBlur(event) {
            const input = event.target; let value = input.value; if (value === '') return;
            const numericValue = parseFloat(value.replace(/,/g, ''));
            if (!isNaN(numericValue)) { input.value = numericValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); } 
            else { input.value = ''; }
        }

        function renderHistoryTable(tableBody, quotes, includePn = false) {
            tableBody.innerHTML = '';
            quotes.forEach(quote => {
                const row = tableBody.insertRow();
                if (includePn) {
                    row.dataset.pn = quote.pn || '';
                    row.dataset.itemName = quote.itemName || '';
                }
                const quoteData = JSON.stringify(quote).replace(/'/g, "&apos;");
                let cells = `
                    <td>${new Date(quote.date).toLocaleDateString()}</td>
                    ${includePn ? `<td>${quote.pn || 'N/A'}</td>` : ''}
                    <td>${quote.sold || 'N/A'}</td>
                    <td class="price-cell">${formatPrice(quote.outrightPrice)}</td>
                    <td class="price-cell">${formatPrice(quote.exchangePrice)}</td>
                    <td><select class="status-select" onchange="handleStatusChange(event, '${quote.id}')">
                        <option value="Quoted" ${quote.status === 'Quoted' ? 'selected' : ''}>Quoted</option>
                        <option value="Sold at Quoted Price" ${quote.status === 'Sold at Quoted Price' ? 'selected' : ''}>Sold at Quoted Price</option>
                        <option value="Lost Sale" ${quote.status === 'Lost Sale' ? 'selected' : ''}>Lost Sale</option>
                    </select></td>
                    <td class="notes-cell">
                        ${quote.notes ? `<button data-action="view-notes" data-quote='${quoteData}'>View</button>` : '—'}
                    </td>
                    <td>
                        <button class="action-button" data-action="edit-quote" data-quote='${quoteData}'>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm.75 0a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm4.5.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0-.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm3.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0-.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>
                        </button>
                    </td>
                `;
                row.innerHTML = cells;
            });
        }

        function listenForQuoteHistory(pn) {
            const quotesRef = database.ref('quotes').orderByChild('pn').equalTo(pn);
            currentHistoryListener = quotesRef;
            
            quotesRef.on('value', (snapshot) => {
                const historyBody = document.getElementById('historyBody');
                const noHistoryMessage = document.getElementById('noHistoryMessage');
                let quotes = [];
                if (snapshot.exists()) {
                    noHistoryMessage.style.display = 'none';
                    snapshot.forEach(childSnapshot => { quotes.push({ id: childSnapshot.key, ...childSnapshot.val() }); });
                    const sortedQuotes = quotes.sort((a, b) => new Date(b.date) - new Date(a.date));
                    renderHistoryTable(historyBody, sortedQuotes);
                } else {
                    historyBody.innerHTML = ''; noHistoryMessage.style.display = 'block';
                }
                renderSalesHistoryGraph(quotes);
            });
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const outrightPriceValue = formData.get('outrightPrice').replace(/,/g, '');
            const exchangePriceValue = formData.get('exchangePrice').replace(/,/g, '');
            const newQuote = {
                pn: document.getElementById('partNumber').textContent,
                itemName: document.getElementById('itemName').textContent,
                sold: formData.get('customer'),
                outrightPrice: outrightPriceValue ? parseFloat(outrightPriceValue) : null,
                exchangePrice: exchangePriceValue ? parseFloat(exchangePriceValue) : null,
                status: formData.get('status'),
                notes: formData.get('notes'),
                date: new Date().toISOString()
            };
            const messageEl = document.getElementById('formMessage');
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true; submitButton.textContent = 'Saving...';
            try {
                await database.ref('quotes').push(newQuote);
                messageEl.textContent = 'Quote saved successfully!'; messageEl.className = 'success'; form.reset(); 
            } catch (error) {
                messageEl.textContent = `Error: ${error.message}`; messageEl.className = 'error';
            } finally {
                setTimeout(() => {
                    messageEl.textContent = ''; messageEl.className = '';
                    submitButton.disabled = false; submitButton.textContent = 'Save Quote';
                }, 2000);
            }
        }

        function fetchAllQuotesForSearch() {
            const quotesRef = database.ref('quotes');
            quotesRef.on('value', (snapshot) => {
                const quotes = snapshot.val();
                if (quotes) {
                    allQuotesCache = Object.keys(quotes).map(key => ({ id: key, ...quotes[key] })).sort((a, b) => new Date(b.date) - new Date(a.date));
                } else { allQuotesCache = []; }
                const searchTerm = document.getElementById('quoteSearchInput').value;
                if (searchTerm) filterAndDisplayQuotes(searchTerm);
            });
        }

        function filterAndDisplayQuotes(searchTerm) {
            const searchHistoryBody = document.getElementById('searchHistoryBody');
            const noResultsMessage = document.getElementById('noSearchResultsMessage');
            if (!searchTerm) {
                searchHistoryBody.innerHTML = ''; noResultsMessage.textContent = 'Type in the search bar to find quotes.'; noResultsMessage.style.display = 'block';
                return;
            }
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredQuotes = allQuotesCache.filter(q => 
                (q.pn && q.pn.toLowerCase().includes(lowerCaseSearchTerm)) || 
                (q.sold && q.sold.toLowerCase().includes(lowerCaseSearchTerm)) || 
                (q.itemName && q.itemName.toLowerCase().includes(lowerCaseSearchTerm))
            );
            if (filteredQuotes.length > 0) {
                noResultsMessage.style.display = 'none';
                renderHistoryTable(searchHistoryBody, filteredQuotes, true);
            } else {
                searchHistoryBody.innerHTML = ''; noResultsMessage.textContent = 'No quotes found matching your search.'; noResultsMessage.style.display = 'block';
            }
        }

        function handleStatusChange(event, quoteId) {
            const newStatus = event.target.value; const selectElement = event.target;
            database.ref('quotes/' + quoteId).update({ status: newStatus })
                .then(() => {
                    selectElement.style.borderColor = '#28a745';
                    setTimeout(() => { selectElement.style.borderColor = '#d1d5db'; }, 1500);
                })
                .catch(error => {
                    console.error('Update failed:', error);
                    selectElement.style.borderColor = '#dc3545';
                    setTimeout(() => { selectElement.style.borderColor = '#d1d5db'; }, 2000);
                });
        }
        
        function openEditModal(quote) {
            const modal = document.getElementById('editModal');
            document.getElementById('editQuoteId').value = quote.id;
            const soldToSelect = document.getElementById('editSoldTo');
            soldToSelect.innerHTML = '';
            soldListCache.forEach(name => {
                const option = document.createElement('option');
                option.value = name; option.textContent = name;
                if (name === quote.sold) option.selected = true;
                soldToSelect.appendChild(option);
            });
            const outright = quote.outrightPrice ? quote.outrightPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
            const exchange = quote.exchangePrice ? quote.exchangePrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
            document.getElementById('editOutrightPrice').value = outright;
            document.getElementById('editExchangePrice').value = exchange;
            document.getElementById('editStatus').value = quote.status;
            document.getElementById('editNotes').value = quote.notes || '';
            modal.classList.add('visible');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('visible');
        }

        async function handleEditFormSubmit() {
            const quoteId = document.getElementById('editQuoteId').value; if (!quoteId) return;
            const outrightPriceValue = document.getElementById('editOutrightPrice').value.replace(/,/g, '');
            const exchangePriceValue = document.getElementById('editExchangePrice').value.replace(/,/g, '');
            const updatedQuote = {
                sold: document.getElementById('editSoldTo').value,
                outrightPrice: outrightPriceValue ? parseFloat(outrightPriceValue) : null,
                exchangePrice: exchangePriceValue ? parseFloat(exchangePriceValue) : null,
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editNotes').value,
            };
            try {
                await database.ref('quotes/' + quoteId).update(updatedQuote);
                closeEditModal();
            } catch (error) {
                console.error("Error updating quote:", error);
                alert("Failed to update quote. See console for details.");
            }
        }

        async function handleDeleteQuote() {
            const quoteId = document.getElementById('editQuoteId').value; if (!quoteId) return;
            if (confirm("Are you sure you want to delete this quote permanently?")) {
                try {
                    await database.ref('quotes/' + quoteId).remove();
                    closeEditModal();
                } catch (error) {
                    console.error("Error deleting quote:", error);
                    alert("Failed to delete quote. See console for details.");
                }
            }
        }

        function renderSalesHistoryGraph(quotes) {
            const canvas = document.getElementById('salesHistoryChart');
            const noSalesDataMessage = document.getElementById('noSalesDataMessage');
            
            const soldQuotes = quotes
                .filter(q => q.status === 'Sold at Quoted Price')
                .sort((a, b) => new Date(a.date) - new Date(b.date)); 

            if (soldQuotes.length === 0) {
                canvas.style.display = 'none';
                noSalesDataMessage.style.display = 'block';
                if (salesHistoryChart) {
                    salesHistoryChart.destroy();
                }
                return;
            }

            canvas.style.display = 'block';
            noSalesDataMessage.style.display = 'none';

            const labels = soldQuotes.map(q => new Date(q.date).toLocaleDateString());
            const outrightData = soldQuotes.map(q => q.outrightPrice);
            const exchangeData = soldQuotes.map(q => q.exchangePrice);

            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Outright Price',
                        data: outrightData,
                        borderColor: '#2d7a7f',
                        backgroundColor: 'rgba(45, 122, 127, 0.1)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Exchange Price',
                        data: exchangeData,
                        borderColor: '#f39237',
                        backgroundColor: 'rgba(243, 146, 55, 0.1)',
                        fill: false,
                        tension: 0.1
                    }
                ]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            };
            
            if (salesHistoryChart) {
                salesHistoryChart.destroy();
            }
            salesHistoryChart = new Chart(canvas, config);
        }

        // NEW: Function to check for and expire old quotes
        async function checkAndExpireQuotes() {
            const quotesRef = database.ref('quotes');
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

            try {
                const snapshot = await quotesRef.orderByChild('status').equalTo('Quoted').once('value');
                if (snapshot.exists()) {
                    const updates = {};
                    snapshot.forEach(childSnapshot => {
                        const quote = childSnapshot.val();
                        const quoteDate = new Date(quote.date).getTime();

                        if (quoteDate < sevenDaysAgo) {
                            updates[`${childSnapshot.key}/status`] = 'Lost Sale';
                        }
                    });

                    if (Object.keys(updates).length > 0) {
                        await database.ref('quotes').update(updates);
                    }
                }
            } catch (error) {
                console.error("Error checking for expired quotes:", error);
            }
        }
    </script>
</body>
</html>

