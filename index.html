<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Sales Quote</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .page-container { width: 100%; max-width: 900px; }
        .main-card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #2d7a7f 0%, #1f5a5e 100%); color: white; padding: 32px; text-align: center; }
        .card-header h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.5px; }
        .card-header h2 { font-size: 18px; font-weight: 400; opacity: 0.95; color: #f39237; }
        .card-content { padding: 32px; }
        section { margin-bottom: 32px; }
        section:last-child { margin-bottom: 0; }
        h3 { font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 16px; }
        .item-info p { font-size: 15px; color: #4b5563; margin-bottom: 8px; line-height: 1.6; }
        .item-info strong { color: #1f2937; font-weight: 600; }
        .divider { border: none; border-top: 1px solid #e5e7eb; margin: 32px 0; }
        .form-group { margin-bottom: 20px; }
        .price-group { display: flex; gap: 20px; }
        .price-group .form-group { flex: 1; }
        label { display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px; }
        input[type="text"], input[type="number"], input[type="search"], select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            background: white;
        }
        textarea { resize: vertical; }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2d7a7f;
            box-shadow: 0 0 0 3px rgba(45, 122, 127, 0.1);
        }
        input::placeholder, textarea::placeholder { color: #9ca3af; }
        button {
            background: linear-gradient(135deg, #2d7a7f 0%, #1f5a5e 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        button:hover { transform: translateY(-1px); }
        button:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
        #formMessage { margin-top: 16px; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; display: none; }
        #formMessage.success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; display: block; }
        #formMessage.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; display: block; }
        .history-container { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f3f4f6; }
        th { text-align: left; padding: 12px; font-weight: 600; color: #374151; font-size: 14px; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        td { padding: 12px; color: #4b5563; font-size: 14px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .price-cell { min-width: 120px; }
        .status-cell { min-width: 180px; }
        .notes-cell button { font-size: 14px; color: #2d7a7f; background: none; border: none; padding: 4px; cursor: pointer; font-weight: 600; }
        .notes-cell button:hover { text-decoration: underline; }
        tbody tr:last-child td { border-bottom: none; }
        #searchHistoryTable tbody tr:hover { background: #f0f9ff; cursor: pointer; } 
        .no-history-message { display: none; text-align: center; padding: 32px; color: #9ca3af; font-size: 15px; }
        
        .action-button { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; }
        .action-button:hover { background-color: #e5e7eb; }
        .action-button svg { width: 20px; height: 20px; color: #6b7280; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .modal-header h4 { font-size: 18px; font-weight: 600; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-footer .btn-secondary { background: #e5e7eb; color: #374151; }
        .modal-footer .btn-danger { background: #ef4444; color: white; }
        .modal-footer .btn-primary { background: #2d7a7f; color: white; }

        .hot-item-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 2px solid #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }

        .filter-btn:hover {
            border-color: #2d7a7f;
            background: #f0f9ff;
            transform: none;
        }

        .filter-btn.active {
            background: #2d7a7f;
            color: white;
            border-color: #2d7a7f;
        }

        @media (max-width: 640px) {
            .card-header h1 { font-size: 24px; }
            .card-header h2 { font-size: 16px; }
            .card-content { padding: 24px; }
            th, td { padding: 8px; font-size: 13px; }
            .price-group { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>

    <div class="page-container">
        <div class="main-card">
            <header class="card-header">
                <h1>iMED ALL inc.</h1>
                <h2>Sales Quote</h2>
            </header>
            <div class="card-content">
                <section class="item-info">
                    <h3>Item Details</h3>
                    <div style="display: flex; gap: 20px; margin-bottom: 16px;">
                        <button onclick="toggleManualEntry()" style="width: auto; padding: 10px 20px;">
                            Toggle Manual Entry
                        </button>
                    </div>
                    <div id="autoItemDetails">
                        <p><strong>Name:</strong> <span id="itemName">Loading...</span><span id="hotItemBadge"></span></p>
                        <p><strong>Part Number:</strong> <span id="partNumber">...</span></p>
                    </div>
                    <div id="manualItemDetails" style="display: none;">
                        <div class="form-group">
                            <label for="manualItemName">Item Name:</label>
                            <input type="text" id="manualItemName" placeholder="Enter item name">
                        </div>
                        <div class="form-group">
                            <label for="manualPartNumber">Part Number:</label>
                            <input type="text" id="manualPartNumber" placeholder="Enter part number">
                        </div>
                    </div>
                </section>

                <hr class="divider">
<section class="quote-form">
                    <h3>Create New Quote</h3>
                    <form id="newQuoteForm">
                        <div class="form-group">
                            <label for="customer">Sold:</label>
                            <select id="customer" name="customer" required>
                                <option value="" disabled selected>Loading Customers...</option>
                            </select>
                        </div>
                        <div class="price-group">
                            <div class="form-group">
                                <label for="exchangePrice">Exchange Quote ($):</label>
                                <input type="text" id="exchangePrice" name="exchangePrice" placeholder="e.g., 1,500.00">
                            </div>
                            <div class="form-group">
                                <label for="outrightPrice">Outright Quote ($):</label>
                                <input type="text" id="outrightPrice" name="outrightPrice" placeholder="e.g., 2,000.00">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="warrantyDays">Warranty (Days):</label>
                            <select id="warrantyDays" name="warrantyDays" onchange="handleWarrantyChange()">
                                <option value="30">30 Days</option>
                                <option value="60" selected>60 Days</option>
                                <option value="90">90 Days</option>
                                <option value="custom">Other (Custom)</option>
                            </select>
                        </div>
                        <div class="form-group" id="customWarrantyGroup" style="display: none;">
                            <label for="customWarranty">Custom Warranty Days:</label>
                            <input type="number" id="customWarranty" placeholder="Enter days" min="1">
                        </div>

                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select id="status" name="status" required>
                                <option value="Quoted">Quoted</option>
                                <option value="Sold at Quoted Price Outright">Sold at Quoted Price Outright</option>
                                <option value="Sold at Quoted Price Exchange">Sold at Quoted Price Exchange</option>
                                <option value="Lost Sale">Lost Sale</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes:</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Add any internal notes for this quote..."></textarea>
                        </div>
                        <button type="submit" id="submitButton">Save Quote</button>
                    </form>
                    <p id="formMessage"></p>
                </section>
                
                <hr class="divider">

                <section class="quote-history">
                    <h3>Quote History for this Part (Latest 10)</h3>
                    <div class="history-container">
                        <table id="historyTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Sold</th>
                                    <th class="price-cell">Exchange</th>
                                    <th class="price-cell">Outright</th>
                                    <th class="status-cell">Status</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody"></tbody>
                        </table>
                        <p id="noHistoryMessage" class="no-history-message">No quote history found for this part.</p>
                    </div>
                </section>

                <hr class="divider">
                <section class="sales-history-graph">
                    <h3>Sales History Graph</h3>
                    <div class="history-container">
                        <canvas id="salesHistoryChart"></canvas>
                        <p id="noSalesDataMessage" class="no-history-message" style="display: none;">No sales history available for this part.</p>
                    </div>
                </section>

                <hr class="divider">

                <section class="searchable-quote-history">
                    <h3 onclick="toggleSearchSection()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>Search All Quotes</span>
                        <span id="searchToggleIcon" style="font-size: 20px;">â–¼</span>
                    </h3>
                    <div id="searchQuotesContent">
                    

                    <div class="form-group">
                        <input type="search" id="quoteSearchInput" placeholder="Search by PN, Sold To, or Item Name...">
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; flex: 1;">
                            <label for="resultsLimit" style="margin: 0; font-size: 14px;">Show:</label>
                            <select id="resultsLimit" style="width: auto; padding: 8px 12px;">
                                <option value="10">10 results</option>
                                <option value="25">25 results</option>
                                <option value="50">50 results</option>
                                <option value="all">All results</option>
                            </select>
                            
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="copySelectedButton" type="button" style="width: auto; padding: 10px 24px; font-size: 14px;" disabled onclick="copySelectedQuotes()">
                                Copy Selected (<span id="copyCount">0</span>)
                            </button>
                            <button id="generatePdfButton" type="button" style="width: auto; padding: 10px 24px; font-size: 14px;" disabled onclick="generatePDF()">
                                Generate PDF (<span id="selectedCount">0</span> selected)
                            </button>
                        </div>
                    </div>
                    <div class="history-container">
                        <table id="searchHistoryTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllCheckbox" style="cursor: pointer;">
                                    </th>
                                    <th>Date</th>
                                    <th>PN</th>
                                    <th>Sold</th>
                                    <th class="price-cell">Exchange</th>
                                    <th class="price-cell">Outright</th>
                                    <th class="status-cell">Status</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="searchHistoryBody"></tbody>
                        </table>
                        <p id="noSearchResultsMessage" class="no-history-message">Type in the search bar to find quotes.</p>
                    </div>
                    </div>
                </section>

                <hr class="divider">
                <section class="price-history-section">
                    <h3>Price History by Part Number</h3>
                    <div class="form-group" style="display: flex; gap: 12px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label for="priceHistorySearchInput">Search Part Number:</label>
                            <input type="text" id="priceHistorySearchInput" placeholder="Enter part number...">
                        </div>
                        <button type="button" onclick="handlePriceHistorySearch()" style="width: auto; padding: 12px 32px;">
                            Search
                        </button>
                    </div>
                    <div class="history-container" id="priceHistoryContainer">
                        <canvas id="priceHistoryChart"></canvas>
                        <p id="noPriceHistoryMessage" class="no-history-message" style="display: none;">
                            No sales history found for this part number.
                        </p>
                    </div>
                </section>
            </div>
        </div>
    </div>
<div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Edit Quote</h4>
            </div>
            <div class="modal-body">
                <form id="editQuoteForm">
                    <input type="hidden" id="editQuoteId">
                    <div class="form-group">
                        <label for="editSoldTo">Sold:</label>
                        <select id="editSoldTo" name="sold" required></select>
                    </div>
                    <div class="price-group">
                        <div class="form-group">
                            <label for="editExchangePrice">Exchange Quote ($):</label>
                            <input type="text" id="editExchangePrice" name="exchangePrice">
                        </div>
                        <div class="form-group">
                            <label for="editOutrightPrice">Outright Quote ($):</label>
                            <input type="text" id="editOutrightPrice" name="outrightPrice">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">Status:</label>
                        <select id="editStatus" name="status" required>
                            <option value="Quoted">Quoted</option>
                            <option value="Sold at Quoted Price Outright">Sold at Quoted Price Outright</option>
                            <option value="Sold at Quoted Price Exchange">Sold at Quoted Price Exchange</option>
                            <option value="Lost Sale">Lost Sale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNotes">Notes:</label>
                        <textarea id="editNotes" name="notes" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="deleteQuoteButton" class="btn-danger">Delete</button>
                <div>
                    <button type="button" id="cancelEditButton" class="btn-secondary">Cancel</button>
                    <button type="button" id="saveEditButton" class="btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>

const firebaseConfig = {
  apiKey: "AIzaSyCe0u6B6qA9y6xvSR_jbY1Do-ljPKy5Lu8",
  authDomain: "imed-sales-quote.firebaseapp.com",
  databaseURL: "https://imed-sales-quote-default-rtdb.firebaseio.com",
  projectId: "imed-sales-quote",
  storageBucket: "imed-sales-quote.firebasestorage.app",
  messagingSenderId: "830326754595",
  appId: "1:830326754595:web:ca03272749599736fad096",
  measurementId: "G-6TCTDFX5PL"
};

const APPSHEET_CONFIG = {
    API_KEY: "V2-p5nLK-I6suM-yAVyE-bhP5n-TaFuq-uDBbY-vjvr0-8RoEu",
    APP_ID: "876dcdc3-0570-427f-9be0-53367d74bf69",
    TABLE_NAME: "Siemens Stock",
    CUSTOMER_COLUMN: "Sold"
};

let allQuotesCache = [];
let soldListCache = [];
let salesHistoryChart;
let priceHistoryChart;
let currentHistoryListener = null;
let selectedQuotes = new Set();
let currentResultsLimit = 25;
let selectedWarrantyDays = 60;
let customWarrantyDays = '';
let currentPriceHistoryPn = null;
let currentTimeFilter = 'all';

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const initialPartNumber = urlParams.get('pn');
    const initialItemName = urlParams.get('name');
    
    if (!initialPartNumber) { 
        document.getElementById('itemName').textContent = 'N/A';
        document.getElementById('partNumber').textContent = 'N/A';
    } else {
        updateMainView(initialPartNumber, initialItemName);
    }
    
    fetchCustomersFromAppSheet();
    fetchAllQuotesForSearch();
    checkAndExpireQuotes();

    document.getElementById('newQuoteForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('quoteSearchInput').addEventListener('input', (e) => filterAndDisplayQuotes(e.target.value));
    document.getElementById('resultsLimit').addEventListener('change', handleResultsLimitChange);
    document.getElementById('selectAllCheckbox').addEventListener('change', handleSelectAll);
    
    ['outrightPrice', 'exchangePrice', 'editOutrightPrice', 'editExchangePrice'].forEach(id => {
        document.getElementById(id).addEventListener('input', handleCurrencyInput);
        document.getElementById(id).addEventListener('blur', handleCurrencyBlur);
    });

    document.getElementById('cancelEditButton').addEventListener('click', closeEditModal);
    document.getElementById('saveEditButton').addEventListener('click', handleEditFormSubmit);
    document.getElementById('deleteQuoteButton').addEventListener('click', handleDeleteQuote);
    document.getElementById('editModal').addEventListener('click', (e) => {
        if (e.target.id === 'editModal') closeEditModal();
    });

    document.body.addEventListener('click', handleBodyClick);
});

function toggleManualEntry() {
    const autoDetails = document.getElementById('autoItemDetails');
    const manualDetails = document.getElementById('manualItemDetails');
    
    if (autoDetails.style.display === 'none') {
        autoDetails.style.display = 'block';
        manualDetails.style.display = 'none';
    } else {
        autoDetails.style.display = 'none';
        manualDetails.style.display = 'block';
    }
}

function toggleSearchSection() {
    const content = document.getElementById('searchQuotesContent');
    const icon = document.getElementById('searchToggleIcon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = 'â–¼';
    } else {
        content.style.display = 'none';
        icon.textContent = 'â–º';
    }
}

function handleWarrantyChange() {
    const select = document.getElementById('warrantyDays');
    const customGroup = document.getElementById('customWarrantyGroup');
    
    if (select.value === 'custom') {
        customGroup.style.display = 'block';
        selectedWarrantyDays = null;
    } else {
        customGroup.style.display = 'none';
        selectedWarrantyDays = parseInt(select.value);
    }
}

function getWarrantyDays() {
    const select = document.getElementById('warrantyDays');
    if (select.value === 'custom') {
        const customValue = document.getElementById('customWarranty').value;
        return customValue ? parseInt(customValue) : 60;
    }
    return parseInt(select.value);
}
async function handleFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    let pn, itemName;
    const autoDetails = document.getElementById('autoItemDetails');
    if (autoDetails.style.display === 'none') {
        pn = document.getElementById('manualPartNumber').value;
        itemName = document.getElementById('manualItemName').value;
    } else {
        pn = document.getElementById('partNumber').textContent;
        itemName = document.getElementById('itemName').textContent;
    }
    
    const outrightPriceValue = formData.get('outrightPrice').replace(/,/g, '');
    const exchangePriceValue = formData.get('exchangePrice').replace(/,/g, '');
    
    const newQuote = {
        pn: pn,
        itemName: itemName,
        sold: formData.get('customer'),
        outrightPrice: outrightPriceValue ? parseFloat(outrightPriceValue) : null,
        exchangePrice: exchangePriceValue ? parseFloat(exchangePriceValue) : null,
        warrantyDays: getWarrantyDays(),
        status: formData.get('status'),
        notes: formData.get('notes'),
        date: new Date().toISOString()
    };
    
    const messageEl = document.getElementById('formMessage');
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = true;
    submitButton.textContent = 'Saving...';
    
    try {
        await database.ref('quotes').push(newQuote);
        messageEl.textContent = 'Quote saved successfully!';
        messageEl.className = 'success';
        form.reset();
        
        document.getElementById('warrantyDays').value = '60';
        document.getElementById('customWarrantyGroup').style.display = 'none';
        selectedWarrantyDays = 60;
        
    } catch (error) {
        messageEl.textContent = `Error: ${error.message}`;
        messageEl.className = 'error';
    } finally {
        setTimeout(() => {
            messageEl.textContent = '';
            messageEl.className = '';
            submitButton.disabled = false;
            submitButton.textContent = 'Save Quote';
        }, 2000);
    }
}

function formatPrice(price) {
    const num = parseFloat(price);
    if (isNaN(num)) return 'â€”';
    return `$${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}


function handleCurrencyInput(event) {
    const input = event.target;
    let value = input.value;
    let cursorPosition = input.selectionStart;
    const commasBefore = (value.substring(0, cursorPosition).match(/,/g) || []).length;
    
    let numericValue = value.replace(/[^0-9.]/g, '');
    const parts = numericValue.split('.');
    if (parts.length > 2) numericValue = parts[0] + '.' + parts.slice(1).join('');
    
    const [integerPart, decimalPart] = numericValue.split('.');
    const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    
    let finalValue = formattedInteger;
    if (decimalPart !== undefined) finalValue += '.' + decimalPart.substring(0, 2);
    
    input.value = finalValue;
    
    const commasAfter = (input.value.substring(0, cursorPosition).match(/,/g) || []).length;
    cursorPosition += (commasAfter - commasBefore);
    if(cursorPosition < 0) cursorPosition = 0;
    input.setSelectionRange(cursorPosition, cursorPosition);
}

function handleCurrencyBlur(event) {
    const input = event.target;
    let value = input.value;
    if (value === '') return;
    
    const numericValue = parseFloat(value.replace(/,/g, ''));
    if (!isNaN(numericValue)) {
        input.value = numericValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    } else {
        input.value = '';
    }
}

function handleTimeFilter(filter) {
    currentTimeFilter = filter;
    
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Re-run the current search with the new filter
    const searchTerm = document.getElementById('quoteSearchInput').value;
    filterAndDisplayQuotes(searchTerm);
}

function getFilteredQuotesByTime(quotes) {
    if (currentTimeFilter === 'all') {
        return quotes;
    }
    
    const now = Date.now();
    let cutoffDate;
    
    switch(currentTimeFilter) {
        case '7days':
            cutoffDate = now - (7 * 24 * 60 * 60 * 1000);
            break;
        case 'month':
            cutoffDate = now - (30 * 24 * 60 * 60 * 1000);
            break;
        case 'year':
            cutoffDate = now - (365 * 24 * 60 * 60 * 1000);
            break;
        default:
            return quotes;
    }
    
    return quotes.filter(quote => {
        const quoteDate = new Date(quote.date).getTime();
        return quoteDate >= cutoffDate;
    });
}

function isHotItem(pn) {
    if (!pn) return false;
    
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    
    const recentQuotes = allQuotesCache.filter(quote => {
        if (quote.pn !== pn) return false;
        const quoteDate = new Date(quote.date).getTime();
        return quoteDate >= sevenDaysAgo;
    });
    
    return recentQuotes.length >= 3;
}

function updateHotItemBadge(pn) {
    const badgeContainer = document.getElementById('hotItemBadge');
    
    if (isHotItem(pn)) {
        badgeContainer.innerHTML = '<span class="hot-item-badge">ðŸ”¥ Hot Item</span>';
    } else {
        badgeContainer.innerHTML = '';
    }
}

function updateMainView(pn, itemName) {
    document.getElementById('itemName').textContent = itemName || 'N/A';
    document.getElementById('partNumber').textContent = pn || 'N/A';
    
    updateHotItemBadge(pn);
    
    if (currentHistoryListener) {
        currentHistoryListener.off();
    }
    listenForQuoteHistory(pn);
    
    renderPriceHistoryChart(pn);
    document.getElementById('priceHistorySearchInput').value = pn;
}
function renderHistoryTable(tableBody, quotes, includePn = false) {
    tableBody.innerHTML = '';
    
    if (quotes.length === 0) return;
    
    quotes.forEach(quote => {
        const row = tableBody.insertRow();
        if (includePn) {
            row.dataset.pn = quote.pn || '';
            row.dataset.itemName = quote.itemName || '';
        }
        
        const quoteData = JSON.stringify(quote).replace(/'/g, "&apos;");
        const isChecked = selectedQuotes.has(quote.id);
        
        let cells = `
            ${includePn ? `<td><input type="checkbox" class="quote-checkbox" data-quote-id="${quote.id}" ${isChecked ? 'checked' : ''} style="cursor: pointer;"></td>` : ''}
            <td>${new Date(quote.date).toLocaleDateString()}</td>
            ${includePn ? `<td>${quote.pn || 'N/A'}</td>` : ''}
            <td>${quote.sold || 'N/A'}</td>
            <td class="price-cell">${formatPrice(quote.exchangePrice)}</td>
            <td class="price-cell">${formatPrice(quote.outrightPrice)}</td>
            <td class="status-cell"><select class="status-select" onchange="handleStatusChange(event, '${quote.id}')">
                <option value="Quoted" ${quote.status === 'Quoted' ? 'selected' : ''}>Quoted</option>
                <option value="Sold at Quoted Price Outright" ${quote.status === 'Sold at Quoted Price Outright' ? 'selected' : ''}>Sold Outright</option>
                <option value="Sold at Quoted Price Exchange" ${quote.status === 'Sold at Quoted Price Exchange' ? 'selected' : ''}>Sold Exchange</option>
                <option value="Lost Sale" ${quote.status === 'Lost Sale' ? 'selected' : ''}>Lost Sale</option>
            </select></td>
            <td class="notes-cell">
                ${quote.notes ? `<button data-action="view-notes" data-quote='${quoteData}'>View</button>` : 'â€”'}
            </td>
            <td>
                <button class="action-button" data-action="edit-quote" data-quote='${quoteData}'>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm.75 0a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm4.5.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0-.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm3.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0-.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>
                </button>
            </td>
        `;
        row.innerHTML = cells;
    });
    
    if (includePn) {
        document.querySelectorAll('.quote-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', handleCheckboxChange);
        });
    }
}

function listenForQuoteHistory(pn) {
    const quotesRef = database.ref('quotes').orderByChild('pn').equalTo(pn);
    currentHistoryListener = quotesRef;
    
    quotesRef.on('value', (snapshot) => {
        const historyBody = document.getElementById('historyBody');
        const noHistoryMessage = document.getElementById('noHistoryMessage');
        let quotes = [];
        
        if (snapshot.exists()) {
            noHistoryMessage.style.display = 'none';
            snapshot.forEach(childSnapshot => {
                quotes.push({ id: childSnapshot.key, ...childSnapshot.val() });
            });
            
            const sortedQuotes = quotes.sort((a, b) => new Date(b.date) - new Date(a.date));
            const latest10 = sortedQuotes.slice(0, 10);
            renderHistoryTable(historyBody, latest10);
        } else {
            historyBody.innerHTML = '';
            noHistoryMessage.style.display = 'block';
        }
        
        renderSalesHistoryGraph(quotes);
    });
}

function fetchAllQuotesForSearch() {
    const quotesRef = database.ref('quotes');
    quotesRef.on('value', (snapshot) => {
        const quotes = snapshot.val();
        if (quotes) {
            allQuotesCache = Object.keys(quotes)
                .map(key => ({ id: key, ...quotes[key] }))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const displayQuotes = getQuotesToDisplay();
            renderHistoryTable(document.getElementById('searchHistoryBody'), displayQuotes, true);
        } else {
            allQuotesCache = [];
            document.getElementById('searchHistoryBody').innerHTML = '';
        }
        
        const searchTerm = document.getElementById('quoteSearchInput').value;
        if (searchTerm) filterAndDisplayQuotes(searchTerm);
        
        // Update hot item badge if we're viewing a part
        const currentPn = document.getElementById('partNumber').textContent;
        if (currentPn && currentPn !== 'N/A') {
            updateHotItemBadge(currentPn);
        }
    });
}

function getQuotesToDisplay() {
    let quotes = getFilteredQuotesByTime(allQuotesCache);
    
    if (currentResultsLimit === 'all') {
        return quotes;
    }
    return quotes.slice(0, parseInt(currentResultsLimit));
}

function handleResultsLimitChange(event) {
    currentResultsLimit = event.target.value;
    const searchTerm = document.getElementById('quoteSearchInput').value;
    
    if (searchTerm) {
        filterAndDisplayQuotes(searchTerm);
    } else {
        const displayQuotes = getQuotesToDisplay();
        renderHistoryTable(document.getElementById('searchHistoryBody'), displayQuotes, true);
        document.getElementById('noSearchResultsMessage').style.display = allQuotesCache.length === 0 ? 'block' : 'none';
    }
}

function filterAndDisplayQuotes(searchTerm) {
    const searchHistoryBody = document.getElementById('searchHistoryBody');
    const noResultsMessage = document.getElementById('noSearchResultsMessage');
    
    let quotesToFilter = getFilteredQuotesByTime(allQuotesCache);
    
    if (!searchTerm) {
        const displayQuotes = getQuotesToDisplay();
        renderHistoryTable(searchHistoryBody, displayQuotes, true);
        noResultsMessage.textContent = 'Type in the search bar to find quotes.';
        noResultsMessage.style.display = quotesToFilter.length === 0 ? 'block' : 'none';
        return;
    }
    
    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    const filteredQuotes = quotesToFilter.filter(q =>
        (q.pn && q.pn.toLowerCase().includes(lowerCaseSearchTerm)) ||
        (q.sold && q.sold.toLowerCase().includes(lowerCaseSearchTerm)) ||
        (q.itemName && q.itemName.toLowerCase().includes(lowerCaseSearchTerm))
    );
    
    const displayQuotes = currentResultsLimit === 'all' ? filteredQuotes : filteredQuotes.slice(0, parseInt(currentResultsLimit));
    
    if (displayQuotes.length > 0) {
        noResultsMessage.style.display = 'none';
        renderHistoryTable(searchHistoryBody, displayQuotes, true);
    } else {
        searchHistoryBody.innerHTML = '';
        noResultsMessage.textContent = 'No quotes found matching your search.';
        noResultsMessage.style.display = 'block';
    }
}
function renderSalesHistoryGraph(quotes) {
    const canvas = document.getElementById('salesHistoryChart');
    const noSalesDataMessage = document.getElementById('noSalesDataMessage');
    
    const soldQuotes = quotes
        .filter(q => q.status === 'Sold at Quoted Price Outright' || q.status === 'Sold at Quoted Price Exchange')
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    if (soldQuotes.length === 0) {
        canvas.style.display = 'none';
        noSalesDataMessage.style.display = 'block';
        if (salesHistoryChart) {
            salesHistoryChart.destroy();
        }
        return;
    }

    canvas.style.display = 'block';
    noSalesDataMessage.style.display = 'none';

    const labels = soldQuotes.map(q => new Date(q.date).toLocaleDateString());
    const exchangeData = soldQuotes.map(q => q.status === 'Sold at Quoted Price Exchange' ? q.exchangePrice : null);
    const outrightData = soldQuotes.map(q => q.status === 'Sold at Quoted Price Outright' ? q.outrightPrice : null);

    const data = {
        labels: labels,
        datasets: [
            {
                label: 'Exchange Sale Price',
                data: exchangeData,
                borderColor: '#f39237',
                backgroundColor: 'rgba(243, 146, 55, 0.1)',
                fill: false,
                tension: 0.1
            },
            {
                label: 'Outright Sale Price',
                data: outrightData,
                borderColor: '#2d7a7f',
                backgroundColor: 'rgba(45, 122, 127, 0.1)',
                fill: false,
                tension: 0.1
            }
        ]
    };

    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    };
    
    if (salesHistoryChart) {
        salesHistoryChart.destroy();
    }
    salesHistoryChart = new Chart(canvas, config);
}

function calculatePriceHistory(pn) {
    if (!pn) return [];
    
    return allQuotesCache
        .filter(quote => quote.pn === pn)
        .map(quote => ({
            date: new Date(quote.date),
            outrightPrice: quote.outrightPrice || null,
            exchangePrice: quote.exchangePrice || null,
            status: quote.status
        }))
        .sort((a, b) => a.date - b.date);
}

function renderPriceHistoryChart(pn) {
    currentPriceHistoryPn = pn;
    const canvas = document.getElementById('priceHistoryChart');
    const noDataMessage = document.getElementById('noPriceHistoryMessage');
    
    const salesData = calculatePriceHistory(pn);
    
    if (salesData.length === 0) {
        canvas.style.display = 'none';
        noDataMessage.style.display = 'block';
        if (priceHistoryChart) {
            priceHistoryChart.destroy();
            priceHistoryChart = null;
        }
        return;
    }
    
    canvas.style.display = 'block';
    noDataMessage.style.display = 'none';
    
    const labels = salesData.map(d => d.date.toLocaleDateString());
    
    const quotedExchange = salesData.map(d => d.status === 'Quoted' ? d.exchangePrice : null);
    const quotedOutright = salesData.map(d => d.status === 'Quoted' ? d.outrightPrice : null);
    const soldExchange = salesData.map(d => d.status === 'Sold at Quoted Price Exchange' ? d.exchangePrice : null);
    const soldOutright = salesData.map(d => d.status === 'Sold at Quoted Price Outright' ? d.outrightPrice : null);
    const lostExchange = salesData.map(d => d.status === 'Lost Sale' ? d.exchangePrice : null);
    const lostOutright = salesData.map(d => d.status === 'Lost Sale' ? d.outrightPrice : null);
    
    const config = {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Quoted - Exchange',
                    data: quotedExchange,
                    borderColor: '#3b82f6',
                    backgroundColor: '#3b82f6',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    borderWidth: 2,
                    tension: 0,
                    spanGaps: false
                },
                {
                    label: 'Quoted - Outright',
                    data: quotedOutright,
                    borderColor: '#93c5fd',
                    backgroundColor: '#93c5fd',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    borderWidth: 2,
                    tension: 0,
                    spanGaps: false
                },
                {
                    label: 'Sold - Exchange',
                    data: soldExchange,
                    borderColor: '#22c55e',
                    backgroundColor: '#22c55e',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    borderWidth: 2,
                    tension: 0,
                    spanGaps: false
                },
                {
                    label: 'Sold - Outright',
                    data: soldOutright,
                    borderColor: '#4ade80',
                    backgroundColor: '#4ade80',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    borderWidth: 2,
                    tension: 0,
                    spanGaps: false
                },
                {
                    label: 'Lost Sale - Exchange',
                    data: lostExchange,
                    borderColor: '#ef4444',
                    backgroundColor: '#ef4444',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    borderWidth: 2,
                    tension: 0,
                    spanGaps: false
                },
                {
                    label: 'Lost Sale - Outright',
                    data: lostOutright,
                    borderColor: '#f87171',
                    backgroundColor: '#f87171',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    borderWidth: 2,
                    tension: 0,
                    spanGaps: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'nearest',
                intersect: false
            },
            plugins: {
                legend: { 
                    position: 'top',
                    labels: {
                        font: { size: 10 },
                        boxWidth: 12,
                        padding: 8,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.parsed.y === null) return null;
                            let label = context.dataset.label || '';
                            label += ': $' + context.parsed.y.toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    };
    
    if (priceHistoryChart) {
        priceHistoryChart.destroy();
    }
    priceHistoryChart = new Chart(canvas, config);
}

function handlePriceHistorySearch() {
    const searchInput = document.getElementById('priceHistorySearchInput');
    const pn = searchInput.value.trim();
    
    if (!pn) {
        alert('Please enter a part number');
        return;
    }
    
    renderPriceHistoryChart(pn);
}
function openEditModal(quote) {
    const modal = document.getElementById('editModal');
    document.getElementById('editQuoteId').value = quote.id;
    
    const soldToSelect = document.getElementById('editSoldTo');
    soldToSelect.innerHTML = '';
    soldListCache.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        if (name === quote.sold) option.selected = true;
        soldToSelect.appendChild(option);
    });
    
    const outright = quote.outrightPrice ? quote.outrightPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
    const exchange = quote.exchangePrice ? quote.exchangePrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
    
    document.getElementById('editOutrightPrice').value = outright;
    document.getElementById('editExchangePrice').value = exchange;
    document.getElementById('editStatus').value = quote.status;
    document.getElementById('editNotes').value = quote.notes || '';
    
    modal.classList.add('visible');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('visible');
}

async function handleEditFormSubmit() {
    const quoteId = document.getElementById('editQuoteId').value;
    if (!quoteId) return;
    
    const outrightPriceValue = document.getElementById('editOutrightPrice').value.replace(/,/g, '');
    const exchangePriceValue = document.getElementById('editExchangePrice').value.replace(/,/g, '');
    
    const updatedQuote = {
        sold: document.getElementById('editSoldTo').value,
        outrightPrice: outrightPriceValue ? parseFloat(outrightPriceValue) : null,
        exchangePrice: exchangePriceValue ? parseFloat(exchangePriceValue) : null,
        status: document.getElementById('editStatus').value,
        notes: document.getElementById('editNotes').value,
    };
    
    try {
        await database.ref('quotes/' + quoteId).update(updatedQuote);
        closeEditModal();
    } catch (error) {
        console.error("Error updating quote:", error);
        alert("Failed to update quote. See console for details.");
    }
}

async function handleDeleteQuote() {
    const quoteId = document.getElementById('editQuoteId').value;
    if (!quoteId) return;
    
    if (confirm("Are you sure you want to delete this quote permanently?")) {
        try {
            await database.ref('quotes/' + quoteId).remove();
            closeEditModal();
        } catch (error) {
            console.error("Error deleting quote:", error);
            alert("Failed to delete quote. See console for details.");
        }
    }
}

function handleStatusChange(event, quoteId) {
    const newStatus = event.target.value;
    const selectElement = event.target;
    
    database.ref('quotes/' + quoteId).update({ status: newStatus })
        .then(() => {
            selectElement.style.borderColor = '#28a745';
            setTimeout(() => {
                selectElement.style.borderColor = '#d1d5db';
            }, 1500);
        })
        .catch(error => {
            console.error('Update failed:', error);
            selectElement.style.borderColor = '#dc3545';
            setTimeout(() => {
                selectElement.style.borderColor = '#d1d5db';
            }, 2000);
        });
}
function handleCheckboxChange(event) {
    const checkbox = event.target;
    const quoteId = checkbox.dataset.quoteId;
    
    if (checkbox.checked) {
        selectedQuotes.add(quoteId);
    } else {
        selectedQuotes.delete(quoteId);
    }
    
    updateSelectedCount();
    updateSelectAllCheckbox();
}

function updateSelectedCount() {
    const count = selectedQuotes.size;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('copyCount').textContent = count;
    document.getElementById('generatePdfButton').disabled = count === 0;
    document.getElementById('copySelectedButton').disabled = count === 0;
}

function handleSelectAll(event) {
    const isChecked = event.target.checked;
    const checkboxes = document.querySelectorAll('.quote-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        const quoteId = checkbox.dataset.quoteId;
        
        if (isChecked) {
            selectedQuotes.add(quoteId);
        } else {
            selectedQuotes.delete(quoteId);
        }
    });
    
    updateSelectedCount();
}

function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.quote-checkbox');
    const checkedBoxes = document.querySelectorAll('.quote-checkbox:checked');
    
    if (checkboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

function copySelectedQuotes() {
    if (selectedQuotes.size === 0) {
        alert('Please select at least one quote to copy.');
        return;
    }
    
    const selected = allQuotesCache.filter(q => selectedQuotes.has(q.id));
    
    let copyText = '';
    
    selected.forEach((quote, index) => {
        copyText += `Item ${index + 1}:\n`;
        copyText += `Name: ${quote.itemName || 'N/A'}\n`;
        copyText += `PN: ${quote.pn || 'N/A'}\n`;
        
        if (quote.exchangePrice) {
            copyText += `Exchange Price: ${formatPrice(quote.exchangePrice)}\n`;
        }
        if (quote.outrightPrice) {
            copyText += `Outright Price: ${formatPrice(quote.outrightPrice)}\n`;
        }
        if (quote.notes && quote.notes.trim() !== '') {
            copyText += `Notes: ${quote.notes}\n`;
        }
        
        copyText += '\n';
    });
    
    navigator.clipboard.writeText(copyText).then(() => {
        const button = document.getElementById('copySelectedButton');
        const originalText = button.innerHTML;
        button.innerHTML = `Copied! (${selected.length})`;
        button.style.backgroundColor = '#28a745';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.backgroundColor = '';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard. Please try again.');
    });
}
async function generatePDF() {
    if (selectedQuotes.size === 0) {
        alert('Please select at least one quote to generate a PDF.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const selected = allQuotesCache.filter(q => selectedQuotes.has(q.id));
    
    const hasOutright = selected.some(q => q.outrightPrice && !isNaN(parseFloat(q.outrightPrice)));
    const hasExchange = selected.some(q => q.exchangePrice && !isNaN(parseFloat(q.exchangePrice)));
    const hasNotes = selected.some(q => q.notes && q.notes.trim() !== '');
    
    const quoteNumber = await getNextQuoteNumber();
    const customerName = selected[0]?.sold || 'N/A';
    const quoteDate = new Date().toLocaleDateString();
    
    // Company info in header (top right)
    doc.setFontSize(8);
    doc.setTextColor(60, 60, 60);
    const companyInfo = [
        'iMED All, Inc.',
        '727 N Main St.',
        'Orange CA, 92868',
        '+1 (714)-271-2721'
    ];
    let yPos = 12;
    companyInfo.forEach(line => {
        doc.text(line, 195, yPos, { align: 'right' });
        yPos += 4;
    });
    
    // Add a line separator
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.line(15, 30, 195, 30);
    
    // Customer info (top left)
    doc.setFontSize(10);
    doc.setTextColor(60, 60, 60);
    doc.text(`Customer: ${customerName}`, 15, 38);
    doc.text(`Date: ${quoteDate}`, 15, 44);
    
    // QUOTE header
    doc.setFontSize(28);
    doc.setTextColor(45, 122, 127);
    doc.setFont(undefined, 'bold');
    doc.text('QUOTE', 15, 60);
    
    doc.setFontSize(11);
    doc.setTextColor(100, 100, 100);
    doc.setFont(undefined, 'normal');
    doc.text(`Quote Number: ${quoteNumber}`, 15, 68);
    
    // Calculate totals
    let totalOutright = 0;
    let totalExchange = 0;
    
    selected.forEach(quote => {
        if (quote.outrightPrice && !isNaN(parseFloat(quote.outrightPrice))) {
            totalOutright += parseFloat(quote.outrightPrice);
        }
        if (quote.exchangePrice && !isNaN(parseFloat(quote.exchangePrice))) {
            totalExchange += parseFloat(quote.exchangePrice);
        }
    });
    
    // Build headers
    const headers = ['Item Name', 'PN'];
    if (hasExchange) headers.push('Exchange');
    if (hasOutright) headers.push('Outright');
    if (hasNotes) headers.push('Notes');
    
    // Build table data
    const tableData = selected.map(quote => {
        const row = [
            quote.itemName || 'N/A',
            quote.pn || 'N/A'
        ];
        
        if (hasExchange) {
            row.push(formatPrice(quote.exchangePrice));
        }
        if (hasOutright) {
            row.push(formatPrice(quote.outrightPrice));
        }
        if (hasNotes) {
            row.push(quote.notes || 'â€”');
        }
        
        return row;
    });
    
    // Build column styles
    const columnStyles = {
        0: { cellWidth: hasNotes ? 50 : 70 },
        1: { cellWidth: hasNotes ? 40 : 50 }
    };
    
    let colIndex = 2;
    if (hasExchange) {
        columnStyles[colIndex] = { cellWidth: 30 };
        colIndex++;
    }
    if (hasOutright) {
        columnStyles[colIndex] = { cellWidth: 30 };
        colIndex++;
    }
    if (hasNotes) {
        columnStyles[colIndex] = { cellWidth: 'auto' };
    }
    
    doc.autoTable({
        startY: 75,
        head: [headers],
        body: tableData,
        theme: 'plain',
        headStyles: {
            fillColor: [45, 122, 127],
            textColor: [255, 255, 255],
            fontSize: 10,
            fontStyle: 'bold',
            lineWidth: 0
        },
        styles: {
            fontSize: 8,
            cellPadding: 4,
            lineColor: [220, 220, 220],
            lineWidth: 0.5,
            fillColor: [250, 250, 250],
            overflow: 'linebreak',
            cellWidth: 'wrap'
        },
        alternateRowStyles: {
            fillColor: [240, 240, 240]
        },
        columnStyles: columnStyles,
        margin: { left: 15, right: 15 },
        tableLineWidth: 0
    });
    
    const finalY = doc.lastAutoTable.finalY;
    
    // Totals section
    if (hasExchange && totalExchange > 0) {
        doc.setFillColor(45, 122, 127);
        doc.rect(15, finalY + 10, 180, 10, 'F');
        doc.setFontSize(12);
        doc.setTextColor(255, 255, 255);
        doc.setFont(undefined, 'bold');
        doc.text(`Total Exchange Price: ${formatPrice(totalExchange)}`, 20, finalY + 17);
    }
    
    if (hasOutright && totalOutright > 0) {
        const yPos = (hasExchange && totalExchange > 0) ? finalY + 22 : finalY + 10;
        
        if (hasExchange && totalExchange > 0) {
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.5);
            doc.line(15, finalY + 21, 195, finalY + 21);
        }
        
        doc.setFillColor(45, 122, 127);
        doc.rect(15, yPos, 180, 10, 'F');
        doc.setFontSize(12);
        doc.setTextColor(255, 255, 255);
        doc.setFont(undefined, 'bold');
        doc.text(`Total Outright Price: ${formatPrice(totalOutright)}`, 20, yPos + 7);
    }
    
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.setFont(undefined, 'normal');
    doc.text(`${quoteNumber} - Page 1 of 2`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
    
    // PAGE 2 - Terms and Conditions
    doc.addPage();
    
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text(quoteNumber, 20, 15);
    
    doc.setFontSize(18);
    doc.setTextColor(45, 122, 127);
    doc.setFont(undefined, 'bold');
    doc.text('Terms and Conditions', 105, 30, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    
    const warrantyDays = selected[0]?.warrantyDays || 60;
    
    const terms = [
        '',
        'Terms in item entry supersede the following general terms.',
        '',
        'SHIPPING',
        'Shipping charges are not included. Shipping terms follow Incoterms 2020 (EXW Orange, California).',
        '',
        'INSURANCE',
        'Buyer is responsible for insuring the package and content.',
        '',
        'SALES',
        'Sales are final and for working genuine used parts. The customer is aware that the items purchased are in used condition and as such may show slight abrasion, scratches or discoloration.',
        '',
        'RESTOCKING',
        'If permitted by seller, items must be returned within 10 days. Buyer pays 25% restocking fee. Seller returns 75% upon return and testing of the restocked parts. Parts must be returned in working condition or the parts will not be accepted for restocking; customer will be responsible for 100% purchase price and shipping cost of the part back to customer.',
        '',
        '',
        '',
        'EXCHANGE SALE',
        'Exchange item needs to be returned prior to shipping of ordered parts unless otherwise agreed and stated, but in any case not later than 30 days. Exchange items must be repairable or outright sale applies.',
        '',
        'WARRANTY',
        `${warrantyDays} days from date of delivery.`,
        '',
        'TAXES AND DUTIES',
        'The customer is responsible for all federal, state or local taxes, customs, or duties as they apply by governing agencies.',
        '',
        'PAYMENT',
        'Payment via bank transfer, direct deposit or secured check. Credit card payments incur an additional 3% processing fee.',
        '',
        'Mail checks to:',
        'iMed All, Inc.',
        '727 N Main St.',
        'Orange, CA 92868',
        ''
    ];
    
    let yPosition = 45;
    const lineHeight = 5.5;
    const pageHeight = doc.internal.pageSize.getHeight();
    const bottomMargin = 20;
    
    terms.forEach(line => {
        if (yPosition > pageHeight - bottomMargin) {
            doc.addPage();
            yPosition = 20;
        }
        
        if (line.match(/^[A-Z\s]+$/) && line.trim() !== '') {
            doc.setFont(undefined, 'bold');
        } else {
            doc.setFont(undefined, 'normal');
        }
        
        doc.text(line, 20, yPosition, { maxWidth: 170 });
        yPosition += lineHeight;
    });
    
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.setFont(undefined, 'normal');
    doc.text(`${quoteNumber} - Page 2 of 2`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
    
    const fileName = `iMED_Quote_${quoteNumber}.pdf`;
    doc.save(fileName);
}

async function getNextQuoteNumber() {
    const counterRef = database.ref('quoteCounter');
    try {
        const snapshot = await counterRef.once('value');
        let currentNumber = snapshot.val() || 0;
        const newNumber = currentNumber + 1;
        await counterRef.set(newNumber);
        return `IMA_Q${newNumber}`;
    } catch (error) {
        console.error("Error generating quote number:", error);
        return `IMA_Q${Date.now()}`;
    }
}
async function fetchCustomersFromAppSheet() {
    const customerSelect = document.getElementById('customer');
    const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.TABLE_NAME);
    const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
            },
            body: JSON.stringify({
                "Action": "Find",
                "Properties": {},
                "Rows": []
            })
        });
        
        if (!response.ok) throw new Error(`Failed to fetch customers: ${response.statusText}`);
        
        const data = await response.json();
        customerSelect.innerHTML = '<option value="" disabled selected>Select from Sold List...</option>';
        
        const customerNames = new Set();
        if (Array.isArray(data)) {
            data.forEach(item => {
                const customerName = item[APPSHEET_CONFIG.CUSTOMER_COLUMN];
                if (customerName && customerName.trim() !== '') {
                    customerNames.add(customerName.trim());
                }
            });
        }
        
        const allCustomers = Array.from(customerNames);
        
        // Sort entire list by most recently used
        if (allQuotesCache.length > 0) {
            const customerLastUsed = new Map();
            
            // Find the most recent date for each customer
            allQuotesCache.forEach(quote => {
                if (quote.sold) {
                    const quoteDate = new Date(quote.date).getTime();
                    const existingDate = customerLastUsed.get(quote.sold);
                    
                    if (!existingDate || quoteDate > existingDate) {
                        customerLastUsed.set(quote.sold, quoteDate);
                    }
                }
            });
            
            // Sort: most recently used first, never used alphabetically at bottom
            allCustomers.sort((a, b) => {
                const aDate = customerLastUsed.get(a) || 0;
                const bDate = customerLastUsed.get(b) || 0;
                
                if (aDate === 0 && bDate === 0) {
                    return a.localeCompare(b); // Alphabetical if neither used
                }
                if (aDate === 0) return 1; // Never used goes to bottom
                if (bDate === 0) return -1;
                
                return bDate - aDate; // Most recent first
            });
        } else {
            allCustomers.sort(); // Alphabetical if no quotes yet
        }
        
        soldListCache = allCustomers;
        
        allCustomers.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            customerSelect.appendChild(option);
        });
    } catch (error) {
        console.error("Error fetching customers:", error);
        customerSelect.innerHTML = '<option value="" disabled>Error loading customers</option>';
    }
}

async function checkAndExpireQuotes() {
    const quotesRef = database.ref('quotes');
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

    try {
        const snapshot = await quotesRef.orderByChild('status').equalTo('Quoted').once('value');
        if (snapshot.exists()) {
            const updates = {};
            snapshot.forEach(childSnapshot => {
                const quote = childSnapshot.val();
                const quoteDate = new Date(quote.date).getTime();

                if (quoteDate < sevenDaysAgo) {
                    updates[`${childSnapshot.key}/status`] = 'Lost Sale';
                }
            });

            if (Object.keys(updates).length > 0) {
                await database.ref('quotes').update(updates);
            }
        }
    } catch (error) {
        console.error("Error checking for expired quotes:", error);
    }
}

function handleBodyClick(e) {
    const actionButton = e.target.closest('[data-action]');
    if (actionButton) {
        const action = actionButton.dataset.action;
        const quote = JSON.parse(actionButton.dataset.quote || '{}');

        if (action === 'edit-quote') {
            openEditModal(quote);
        } else if (action === 'view-notes') {
            alert(quote.notes || 'No notes for this quote.');
        }
        return;
    }

    const searchRow = e.target.closest('#searchHistoryBody tr');
    if (searchRow) {
        if (e.target.closest('select, button, input[type="checkbox"]')) {
            return;
        }

        const pn = searchRow.dataset.pn;
        const itemName = searchRow.dataset.itemName;
        if (pn && itemName) {
            updateMainView(pn, itemName);
            window.scrollTo(0, 0);
        }
    }
}
    </script>
</body>
</html>
